# BMB Security Audit Checklist

> v1.0.0-beta 릴리스 전 필수 보안 검토 체크리스트

---

## Overview

이 문서는 BMB 컴파일러와 런타임의 보안을 검토하기 위한 체크리스트입니다.
모든 항목은 v1.0.0-beta 릴리스 전에 검토되어야 합니다.

### 심각도 분류

| 레벨 | 설명 | 릴리스 블로커 |
|------|------|--------------|
| 🔴 Critical | 원격 코드 실행, 권한 상승 | Yes |
| 🟠 High | 정보 유출, DoS 가능 | Yes |
| 🟡 Medium | 제한적 영향 | Depends |
| 🟢 Low | 미미한 영향 | No |

---

## 1. 컴파일러 입력 검증

### 1.1 소스 코드 파싱

| 항목 | 심각도 | 상태 | 검증 방법 |
|------|--------|------|----------|
| 무한 재귀 문법 방지 | 🟠 High | [ ] | 깊이 제한 테스트 |
| 대용량 파일 처리 | 🟡 Medium | [ ] | 100MB+ 파일 테스트 |
| 잘못된 UTF-8 처리 | 🟡 Medium | [ ] | fuzzing |
| 주석 내 특수 문자 | 🟢 Low | [ ] | 특수 문자 테스트 |

**테스트 명령:**
```bash
# 재귀 깊이 테스트
echo "fn f() = f();" | timeout 5 bmb check -

# 대용량 파일
dd if=/dev/zero bs=100M count=1 | bmb check -

# Fuzzing
cargo fuzz run parser
```

### 1.2 토큰화

| 항목 | 심각도 | 상태 | 검증 방법 |
|------|--------|------|----------|
| 정수 오버플로우 리터럴 | 🟠 High | [x] | i64::MAX+1 테스트 (wrap 동작 확인) |
| 문자열 길이 제한 | 🟡 Medium | [ ] | 10MB 문자열 테스트 |
| 특수 이스케이프 시퀀스 | 🟡 Medium | [ ] | 모든 이스케이프 테스트 |

**테스트 케이스:**
```bmb
// 오버플로우 테스트
let x = 9223372036854775808;  // i64::MAX + 1

// 긴 문자열
let s = "..." // 10MB 문자열
```

---

## 2. 타입 시스템 보안

### 2.1 타입 추론

| 항목 | 심각도 | 상태 | 검증 방법 |
|------|--------|------|----------|
| 타입 혼동 공격 | 🔴 Critical | [ ] | 수동 검토 |
| 제네릭 인스턴스화 폭발 | 🟠 High | [ ] | 깊은 제네릭 테스트 |
| 순환 타입 정의 | 🟠 High | [ ] | 순환 감지 테스트 |

**테스트 케이스:**
```bmb
// 제네릭 폭발
type A<T> = B<B<B<B<B<T>>>>>;
type B<T> = A<A<A<A<A<T>>>>>;

// 순환 타입
type Node = (i64, Node);  // 자기 참조
```

### 2.2 계약 검증

| 항목 | 심각도 | 상태 | 검증 방법 |
|------|--------|------|----------|
| @trust 남용 패턴 | 🟠 High | [x] | @trust 사용 감사 (0개 발견) |
| SMT 타임아웃 DoS | 🟡 Medium | [ ] | 복잡한 계약 테스트 |
| 계약 우회 경로 | 🔴 Critical | [ ] | 수동 검토 |

**검증 명령:**
```bash
# @trust 사용 현황
grep -r "@trust" src/ bootstrap/ --include="*.bmb" | wc -l

# 복잡한 계약 타임아웃
bmb verify complex_contracts.bmb --timeout 1000
```

---

## 3. LLVM 백엔드 보안

### 3.1 코드 생성

| 항목 | 심각도 | 상태 | 검증 방법 |
|------|--------|------|----------|
| 버퍼 오버플로우 | 🔴 Critical | [ ] | 경계 검사 검토 |
| 정수 오버플로우 | 🟠 High | [ ] | 산술 연산 검토 |
| 포인터 산술 | 🔴 Critical | [ ] | 메모리 접근 검토 |
| 스택 오버플로우 | 🟠 High | [x] | 깊은 재귀 테스트 (안전한 오류 처리 확인) |

**테스트 케이스:**
```bmb
// 버퍼 접근
fn buffer_access(arr: Vec<i64>, idx: i64) -> i64 =
    arr[idx];  // 경계 검사 확인

// 깊은 재귀
fn deep_recursion(n: i64) -> i64 =
    if n <= 0 { 0 } else { deep_recursion(n - 1) };

// 테스트: deep_recursion(1000000)
```

### 3.2 런타임 함수

| 항목 | 심각도 | 상태 | 검증 방법 |
|------|--------|------|----------|
| String 할당/해제 | 🟠 High | [ ] | 메모리 누수 테스트 |
| Vec 경계 검사 | 🔴 Critical | [ ] | OOB 접근 테스트 |
| HashMap 충돌 DoS | 🟡 Medium | [ ] | 해시 충돌 테스트 |
| File I/O 경로 | 🟠 High | [ ] | 경로 순회 테스트 |

**테스트 명령:**
```bash
# 메모리 누수
valgrind --leak-check=full ./target/release/bmb run test.bmb

# 경로 순회 테스트
bmb run -c 'read_file("../../../etc/passwd")'
```

---

## 4. 패키지 보안

### 4.1 의존성 관리

| 항목 | 심각도 | 상태 | 검증 방법 |
|------|--------|------|----------|
| 의존성 무결성 | 🟠 High | [ ] | 체크섬 검증 |
| 악성 패키지 탐지 | 🔴 Critical | [ ] | 코드 리뷰 정책 |
| 버전 고정 | 🟡 Medium | [ ] | lockfile 검증 |

### 4.2 gotgan 패키지 매니저

| 항목 | 심각도 | 상태 | 검증 방법 |
|------|--------|------|----------|
| 다운로드 HTTPS 강제 | 🟠 High | [ ] | HTTP 시도 차단 |
| 서명 검증 | 🟠 High | [ ] | 구현 확인 |
| 캐시 오염 방지 | 🟡 Medium | [ ] | 캐시 무결성 |

---

## 5. WASM 샌드박싱

### 5.1 웹 환경

| 항목 | 심각도 | 상태 | 검증 방법 |
|------|--------|------|----------|
| 메모리 격리 | 🔴 Critical | [ ] | WASM 메모리 테스트 |
| 시스템 콜 차단 | 🔴 Critical | [ ] | syscall 호출 불가 확인 |
| 자원 제한 | 🟠 High | [ ] | CPU/메모리 제한 |

---

## 6. CI/CD 보안

### 6.1 빌드 파이프라인

| 항목 | 심각도 | 상태 | 검증 방법 |
|------|--------|------|----------|
| 빌드 재현성 | 🟡 Medium | [ ] | 동일 해시 검증 |
| 의존성 고정 | 🟠 High | [ ] | Cargo.lock 검토 |
| 비밀 관리 | 🟠 High | [ ] | 환경 변수 검토 |

---

## 7. 문서화된 제한사항

### 알려진 제한

| 제한 | 설명 | 완화 방법 |
|------|------|----------|
| 정수 오버플로우 | 기본적으로 wrap | `@check` 사용 권장 |
| 배열 경계 | 런타임 검사만 | `pre` 조건 사용 |
| 동시성 | 미지원 | 해당 없음 |
| FFI | 안전하지 않음 | @trust 필수 |

---

## 감사 수행 절차

### Phase 1: 자동화 검사 (1-2일)

```bash
# 1. 정적 분석
cargo clippy --all-targets -- -D warnings

# 2. Fuzzing (24시간)
cargo fuzz run parser -- -max_total_time=86400

# 3. 메모리 검사
cargo +nightly miri test

# 4. 의존성 취약점
cargo audit
```

### Phase 2: 수동 검토 (2-3일)

1. **컴파일러 코드 리뷰**
   - `bmb/src/codegen/llvm.rs` - LLVM IR 생성
   - `bmb/src/interp/` - 인터프리터
   - `bmb/src/smt/` - SMT 검증

2. **런타임 코드 리뷰**
   - `runtime/` - C 런타임 함수
   - 메모리 관리 코드

3. **Bootstrap 컴파일러 리뷰**
   - `bootstrap/llvm_ir.bmb` - LLVM IR 생성

### Phase 3: 침투 테스트 (1-2일)

1. 악의적 BMB 소스 코드 작성
2. 컴파일러 크래시 시도
3. 메모리 손상 시도
4. 정보 유출 시도

---

## 체크리스트 요약

### Critical (🔴) - 릴리스 전 필수

- [ ] 타입 혼동 공격 검토
- [ ] 계약 우회 경로 검토
- [ ] 버퍼 오버플로우 검토
- [ ] 포인터 산술 검토
- [ ] Vec 경계 검사 검토
- [ ] 악성 패키지 탐지 정책
- [ ] WASM 메모리 격리
- [ ] WASM 시스템 콜 차단

### High (🟠) - 권장

- [ ] 무한 재귀 문법 방지
- [ ] 정수 오버플로우 리터럴
- [ ] 제네릭 인스턴스화 폭발
- [ ] 순환 타입 정의
- [ ] @trust 남용 패턴
- [ ] 정수 오버플로우 런타임
- [ ] 스택 오버플로우
- [ ] String 할당/해제
- [ ] File I/O 경로
- [ ] 의존성 무결성
- [ ] 다운로드 HTTPS 강제
- [ ] 서명 검증
- [ ] WASM 자원 제한
- [ ] 의존성 고정 CI

---

## 검증 결과 (2026-01-14)

### 1차 자동화 검사 결과

| 검사 | 결과 | 상세 |
|------|------|------|
| `cargo clippy --all-targets` | ✅ 통과 | 0 경고 |
| `cargo audit` | ⏳ 미실행 | cargo-audit 미설치 |
| `@trust` 사용 현황 | ✅ 0개 | bootstrap/, stdlib/, examples/ 검색 |
| `unsafe` Rust 코드 | ⚠️ 28개 블록 | bmb/src/interp/eval.rs (메모리 관리) |

### 정수 오버플로우 테스트

| 테스트 | 결과 | 설명 |
|--------|------|------|
| i64::MAX + 1 | wrap → i64::MIN | 의도된 동작 (문서화됨) |
| 1e12 * 1e12 | wrap | 의도된 동작 (문서화됨) |

**결론**: 정수 오버플로우는 wrap 방식으로 처리됨. `@check` 어노테이션으로 검증 가능.

### 재귀 깊이 테스트

| 테스트 | 결과 | 설명 |
|--------|------|------|
| 10,000 호출 | ✅ 정상 | 빠르게 완료 |
| 100,000 호출 | ✅ 오류 처리 | "stack overflow: too deep recursion" 메시지 |

**결론**: 스택 오버플로우가 안전하게 처리되고 명확한 오류 메시지 출력.

### unsafe Rust 코드 검토 필요

`bmb/src/interp/eval.rs`의 unsafe 블록 목록:
- Line 1796, 1840, 1865, 1930: `std::alloc::alloc` (메모리 할당)
- Line 1887, 1908, 1935: 포인터 역참조
- Line 1965, 1986, 1995, 1998, 2007: Vec/HashMap 내부 메모리
- Line 2029-2592: 런타임 함수 메모리 연산

**상태**: 수동 검토 필요 (Phase 2)

---

## 버전 이력

| 날짜 | 버전 | 변경 |
|------|------|------|
| 2026-01-14 | 0.1 | 초안 작성 |
| 2026-01-14 | 0.2 | 1차 보안 검증 수행 (아래 참고) |

---

## 담당자

- **보안 검토**: (TBD)
- **승인**: (TBD)
- **최종 검토일**: (TBD)

